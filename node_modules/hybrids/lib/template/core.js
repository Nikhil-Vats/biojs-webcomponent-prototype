"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createId = createId;
exports.createInternalWalker = createInternalWalker;
exports.compile = compile;

var _utils = require("../utils");

var _utils2 = require("./utils");

var _value = _interopRequireDefault(require("./resolvers/value"));

var _property = _interopRequireDefault(require("./resolvers/property"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance"); }

function _iterableToArrayLimit(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

var TIMESTAMP = Date.now();

var getPlaceholder = function getPlaceholder() {
  var id = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 0;
  return "{{h-".concat(TIMESTAMP, "-").concat(id, "}}");
};

var PLACEHOLDER_REGEXP_TEXT = getPlaceholder('(\\d+)');
var PLACEHOLDER_REGEXP_EQUAL = new RegExp("^".concat(PLACEHOLDER_REGEXP_TEXT, "$"));
var PLACEHOLDER_REGEXP_ALL = new RegExp(PLACEHOLDER_REGEXP_TEXT, 'g');
var ATTR_PREFIX = "--".concat(TIMESTAMP, "--");
var ATTR_REGEXP = new RegExp(ATTR_PREFIX, 'g');
var preparedTemplates = new WeakMap();
/* istanbul ignore next */

function applyShadyCSS(template, tagName) {
  if (!tagName) return template;
  return (0, _utils.shadyCSS)(function (shady) {
    var map = preparedTemplates.get(template);

    if (!map) {
      map = new Map();
      preparedTemplates.set(template, map);
    }

    var clone = map.get(tagName);

    if (!clone) {
      clone = document.createElement('template');
      clone.content.appendChild(template.content.cloneNode(true));
      map.set(tagName, clone);
      var styles = clone.content.querySelectorAll('style');
      Array.from(styles).forEach(function (style) {
        var count = style.childNodes.length + 1;

        for (var i = 0; i < count; i += 1) {
          style.parentNode.insertBefore(document.createTextNode(getPlaceholder()), style);
        }
      });
      shady.prepareTemplate(clone, tagName.toLowerCase());
    }

    return clone;
  }, template);
}

function createId(parts, isSVG) {
  return "".concat(isSVG ? 'svg:' : '').concat(parts.join(getPlaceholder()));
}

function createSignature(parts) {
  var signature = parts.reduce(function (acc, part, index) {
    if (index === 0) {
      return part;
    }

    if (parts.slice(index).join('').match(/\s*<\/\s*(table|tr|thead|tbody|tfoot|colgroup)>/)) {
      return "".concat(acc, "<!--").concat(getPlaceholder(index - 1), "-->").concat(part);
    }

    return acc + getPlaceholder(index - 1) + part;
  }, '');
  /* istanbul ignore if */

  if (_utils.IS_IE) {
    return signature.replace(/style\s*=\s*(["][^"]+["]|['][^']+[']|[^\s"'<>/]+)/g, function (match) {
      return "".concat(ATTR_PREFIX).concat(match);
    });
  }

  return signature;
}

function getPropertyName(string) {
  return string.replace(/\s*=\s*['"]*$/g, '').split(' ').pop();
}

function replaceComments(fragment) {
  var iterator = document.createNodeIterator(fragment, NodeFilter.SHOW_COMMENT, null, false);
  var node; // eslint-disable-next-line no-cond-assign

  while (node = iterator.nextNode()) {
    if (PLACEHOLDER_REGEXP_EQUAL.test(node.textContent)) {
      node.parentNode.insertBefore(document.createTextNode(node.textContent), node);
      node.parentNode.removeChild(node);
    }
  }
}

function createInternalWalker(context) {
  var node;
  return {
    get currentNode() {
      return node;
    },

    nextNode: function nextNode() {
      if (node === undefined) {
        node = context.childNodes[0];
      } else if (node.childNodes.length) {
        node = node.childNodes[0];
      } else if (node.nextSibling) {
        node = node.nextSibling;
      } else {
        node = node.parentNode.nextSibling;
      }

      return !!node;
    }
  };
}

function createExternalWalker(context) {
  return document.createTreeWalker(context, // eslint-disable-next-line no-bitwise
  NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_TEXT, null, false);
}
/* istanbul ignore next */


var createWalker = _typeof(window.ShadyDOM) === 'object' && window.ShadyDOM.inUse ? createInternalWalker : createExternalWalker;
var container = document.createElement('div');

function compile(rawParts, isSVG) {
  var template = document.createElement('template');
  var parts = [];
  var signature = createSignature(rawParts);
  if (isSVG) signature = "<svg>".concat(signature, "</svg>");
  /* istanbul ignore if */

  if (_utils.IS_IE) {
    template.innerHTML = signature;
  } else {
    container.innerHTML = "<template>".concat(signature, "</template>");
    template.content.appendChild(container.children[0].content);
  }

  if (isSVG) {
    var svgRoot = template.content.firstChild;
    template.content.removeChild(svgRoot);
    Array.from(svgRoot.childNodes).forEach(function (node) {
      return template.content.appendChild(node);
    });
  }

  replaceComments(template.content);
  var compileWalker = createWalker(template.content);
  var compileIndex = 0;

  var _loop = function _loop() {
    var node = compileWalker.currentNode;

    if (node.nodeType === Node.TEXT_NODE) {
      var text = node.textContent;

      if (!text.match(PLACEHOLDER_REGEXP_EQUAL)) {
        var results = text.match(PLACEHOLDER_REGEXP_ALL);

        if (results) {
          var currentNode = node;
          results.reduce(function (acc, placeholder) {
            var _acc$pop$split = acc.pop().split(placeholder),
                _acc$pop$split2 = _slicedToArray(_acc$pop$split, 2),
                before = _acc$pop$split2[0],
                next = _acc$pop$split2[1];

            if (before) acc.push(before);
            acc.push(placeholder);
            if (next) acc.push(next);
            return acc;
          }, [text]).forEach(function (part, index) {
            if (index === 0) {
              currentNode.textContent = part;
            } else {
              currentNode = currentNode.parentNode.insertBefore(document.createTextNode(part), currentNode.nextSibling);
            }
          });
        }
      }

      var equal = node.textContent.match(PLACEHOLDER_REGEXP_EQUAL);

      if (equal) {
        /* istanbul ignore else */
        if (!_utils.IS_IE) node.textContent = '';
        parts[equal[1]] = [compileIndex, _value.default];
      }
    } else {
      /* istanbul ignore else */
      // eslint-disable-next-line no-lonely-if
      if (node.nodeType === Node.ELEMENT_NODE) {
        Array.from(node.attributes).forEach(function (attr) {
          var value = attr.value.trim();
          /* istanbul ignore next */

          var name = _utils.IS_IE ? attr.name.replace(ATTR_PREFIX, '') : attr.name;
          var equal = value.match(PLACEHOLDER_REGEXP_EQUAL);

          if (equal) {
            var propertyName = getPropertyName(rawParts[equal[1]]);
            parts[equal[1]] = [compileIndex, (0, _property.default)(name, propertyName, isSVG)];
            node.removeAttribute(attr.name);
          } else {
            var _results = value.match(PLACEHOLDER_REGEXP_ALL);

            if (_results) {
              var partialName = "attr__".concat(name);

              _results.forEach(function (placeholder, index) {
                var _placeholder$match = placeholder.match(PLACEHOLDER_REGEXP_EQUAL),
                    _placeholder$match2 = _slicedToArray(_placeholder$match, 2),
                    id = _placeholder$match2[1];

                parts[id] = [compileIndex, function (host, target, attrValue) {
                  var data = _utils2.dataMap.get(target, {});

                  data[partialName] = (data[partialName] || value).replace(placeholder, attrValue == null ? '' : attrValue);

                  if (_results.length === 1 || index + 1 === _results.length) {
                    target.setAttribute(name, data[partialName]);
                    data[partialName] = undefined;
                  }
                }];
              });

              attr.value = '';
              /* istanbul ignore next */

              if (_utils.IS_IE && name !== attr.name) {
                node.removeAttribute(attr.name);
                node.setAttribute(name, '');
              }
            }
          }
        });
      }
    }

    compileIndex += 1;
  };

  while (compileWalker.nextNode()) {
    _loop();
  }

  return function (host, target, args) {
    var data = _utils2.dataMap.get(target, {
      type: 'function'
    });

    if (template !== data.template) {
      if (data.template) (0, _utils2.removeTemplate)(target);
      var fragment = document.importNode(applyShadyCSS(template, host.tagName).content, true);
      var renderWalker = createWalker(fragment);
      var clonedParts = parts.slice(0);
      var renderIndex = 0;
      var currentPart = clonedParts.shift();
      var markers = [];
      Object.assign(data, {
        template: template,
        markers: markers
      });

      while (renderWalker.nextNode()) {
        var node = renderWalker.currentNode;

        if (node.nodeType === Node.TEXT_NODE) {
          /* istanbul ignore next */
          if (PLACEHOLDER_REGEXP_EQUAL.test(node.textContent)) {
            node.textContent = '';
          } else if (_utils.IS_IE) {
            node.textContent = node.textContent.replace(ATTR_REGEXP, '');
          }
        } else if (process.env.NODE_ENV !== 'production' && node.nodeType === Node.ELEMENT_NODE) {
          if (node.tagName.indexOf('-') > -1 && !customElements.get(node.tagName.toLowerCase())) {
            throw Error("Missing '".concat((0, _utils.stringifyElement)(node), "' element definition in '").concat((0, _utils.stringifyElement)(host), "'"));
          }
        }

        while (currentPart && currentPart[0] === renderIndex) {
          markers.push([node, currentPart[1]]);
          currentPart = clonedParts.shift();
        }

        renderIndex += 1;
      }

      var childList = Array.from(fragment.childNodes);
      data.startNode = childList[0];
      data.endNode = childList[childList.length - 1];

      if (target.nodeType === Node.TEXT_NODE) {
        var previousChild = target;
        childList.forEach(function (child) {
          target.parentNode.insertBefore(child, previousChild.nextSibling);
          previousChild = child;
        });
      } else {
        target.appendChild(fragment);
      }
    }

    data.markers.forEach(function (_ref, index) {
      var _ref2 = _slicedToArray(_ref, 2),
          node = _ref2[0],
          fn = _ref2[1];

      if (data.lastArgs && data.lastArgs[index] === args[index]) return;
      fn(host, node, args[index], data.lastArgs ? data.lastArgs[index] : undefined);
    });
    data.lastArgs = args;
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90ZW1wbGF0ZS9jb3JlLmpzIl0sIm5hbWVzIjpbIlRJTUVTVEFNUCIsIkRhdGUiLCJub3ciLCJnZXRQbGFjZWhvbGRlciIsImlkIiwiUExBQ0VIT0xERVJfUkVHRVhQX1RFWFQiLCJQTEFDRUhPTERFUl9SRUdFWFBfRVFVQUwiLCJSZWdFeHAiLCJQTEFDRUhPTERFUl9SRUdFWFBfQUxMIiwiQVRUUl9QUkVGSVgiLCJBVFRSX1JFR0VYUCIsInByZXBhcmVkVGVtcGxhdGVzIiwiV2Vha01hcCIsImFwcGx5U2hhZHlDU1MiLCJ0ZW1wbGF0ZSIsInRhZ05hbWUiLCJzaGFkeSIsIm1hcCIsImdldCIsIk1hcCIsInNldCIsImNsb25lIiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50IiwiY29udGVudCIsImFwcGVuZENoaWxkIiwiY2xvbmVOb2RlIiwic3R5bGVzIiwicXVlcnlTZWxlY3RvckFsbCIsIkFycmF5IiwiZnJvbSIsImZvckVhY2giLCJzdHlsZSIsImNvdW50IiwiY2hpbGROb2RlcyIsImxlbmd0aCIsImkiLCJwYXJlbnROb2RlIiwiaW5zZXJ0QmVmb3JlIiwiY3JlYXRlVGV4dE5vZGUiLCJwcmVwYXJlVGVtcGxhdGUiLCJ0b0xvd2VyQ2FzZSIsImNyZWF0ZUlkIiwicGFydHMiLCJpc1NWRyIsImpvaW4iLCJjcmVhdGVTaWduYXR1cmUiLCJzaWduYXR1cmUiLCJyZWR1Y2UiLCJhY2MiLCJwYXJ0IiwiaW5kZXgiLCJzbGljZSIsIm1hdGNoIiwiSVNfSUUiLCJyZXBsYWNlIiwiZ2V0UHJvcGVydHlOYW1lIiwic3RyaW5nIiwic3BsaXQiLCJwb3AiLCJyZXBsYWNlQ29tbWVudHMiLCJmcmFnbWVudCIsIml0ZXJhdG9yIiwiY3JlYXRlTm9kZUl0ZXJhdG9yIiwiTm9kZUZpbHRlciIsIlNIT1dfQ09NTUVOVCIsIm5vZGUiLCJuZXh0Tm9kZSIsInRlc3QiLCJ0ZXh0Q29udGVudCIsInJlbW92ZUNoaWxkIiwiY3JlYXRlSW50ZXJuYWxXYWxrZXIiLCJjb250ZXh0IiwiY3VycmVudE5vZGUiLCJ1bmRlZmluZWQiLCJuZXh0U2libGluZyIsImNyZWF0ZUV4dGVybmFsV2Fsa2VyIiwiY3JlYXRlVHJlZVdhbGtlciIsIlNIT1dfRUxFTUVOVCIsIlNIT1dfVEVYVCIsImNyZWF0ZVdhbGtlciIsIndpbmRvdyIsIlNoYWR5RE9NIiwiaW5Vc2UiLCJjb250YWluZXIiLCJjb21waWxlIiwicmF3UGFydHMiLCJpbm5lckhUTUwiLCJjaGlsZHJlbiIsInN2Z1Jvb3QiLCJmaXJzdENoaWxkIiwiY29tcGlsZVdhbGtlciIsImNvbXBpbGVJbmRleCIsIm5vZGVUeXBlIiwiTm9kZSIsIlRFWFRfTk9ERSIsInRleHQiLCJyZXN1bHRzIiwicGxhY2Vob2xkZXIiLCJiZWZvcmUiLCJuZXh0IiwicHVzaCIsImVxdWFsIiwicmVzb2x2ZVZhbHVlIiwiRUxFTUVOVF9OT0RFIiwiYXR0cmlidXRlcyIsImF0dHIiLCJ2YWx1ZSIsInRyaW0iLCJuYW1lIiwicHJvcGVydHlOYW1lIiwicmVtb3ZlQXR0cmlidXRlIiwicGFydGlhbE5hbWUiLCJob3N0IiwidGFyZ2V0IiwiYXR0clZhbHVlIiwiZGF0YSIsImRhdGFNYXAiLCJzZXRBdHRyaWJ1dGUiLCJhcmdzIiwidHlwZSIsImltcG9ydE5vZGUiLCJyZW5kZXJXYWxrZXIiLCJjbG9uZWRQYXJ0cyIsInJlbmRlckluZGV4IiwiY3VycmVudFBhcnQiLCJzaGlmdCIsIm1hcmtlcnMiLCJPYmplY3QiLCJhc3NpZ24iLCJwcm9jZXNzIiwiZW52IiwiTk9ERV9FTlYiLCJpbmRleE9mIiwiY3VzdG9tRWxlbWVudHMiLCJFcnJvciIsImNoaWxkTGlzdCIsInN0YXJ0Tm9kZSIsImVuZE5vZGUiLCJwcmV2aW91c0NoaWxkIiwiY2hpbGQiLCJmbiIsImxhc3RBcmdzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFDQTs7Ozs7Ozs7Ozs7Ozs7QUFFQSxJQUFNQSxTQUFTLEdBQUdDLElBQUksQ0FBQ0MsR0FBTCxFQUFs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QUFDRCxTQUhEO0FBSUQsT0FORCxNQU1PO0FBQ0wxQixRQUFBQSxNQUFNLENBQUN6RixXQUFQLENBQW1Cb0MsUUFBbkI7QUFDRDtBQUNGOztBQUVEdUQsSUFBQUEsSUFBSSxDQUFDVyxPQUFMLENBQWFoRyxPQUFiLENBQXFCLGdCQUFhb0IsS0FBYixFQUF1QjtBQUFBO0FBQUEsVUFBckJlLElBQXFCO0FBQUEsVUFBZjJFLEVBQWU7O0FBQzFDLFVBQUl6QixJQUFJLENBQUMwQixRQUFMLElBQWlCMUIsSUFBSSxDQUFDMEIsUUFBTCxDQUFjM0YsS0FBZCxNQUF5Qm9FLElBQUksQ0FBQ3BFLEtBQUQsQ0FBbEQsRUFBMkQ7QUFDM0QwRixNQUFBQSxFQUFFLENBQUM1QixJQUFELEVBQU8vQyxJQUFQLEVBQWFxRCxJQUFJLENBQUNwRSxLQUFELENBQWpCLEVBQTBCaUUsSUFBSSxDQUFDMEIsUUFBTCxHQUFnQjFCLElBQUksQ0FBQzBCLFFBQUwsQ0FBYzNGLEtBQWQsQ0FBaEIsR0FBdUN1QixTQUFqRSxDQUFGO0FBQ0QsS0FIRDtBQUtBMEMsSUFBQUEsSUFBSSxDQUFDMEIsUUFBTCxHQUFnQnZCLElBQWhCO0FBQ0QsR0FoRUQ7QUFpRUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzdHJpbmdpZnlFbGVtZW50LCBzaGFkeUNTUywgSVNfSUUgfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgeyBkYXRhTWFwLCByZW1vdmVUZW1wbGF0ZSB9IGZyb20gJy4vdXRpbHMnO1xuXG5pbXBvcnQgcmVzb2x2ZVZhbHVlIGZyb20gJy4vcmVzb2x2ZXJzL3ZhbHVlJztcbmltcG9ydCByZXNvbHZlUHJvcGVydHkgZnJvbSAnLi9yZXNvbHZlcnMvcHJvcGVydHknO1xuXG5jb25zdCBUSU1FU1RBTVAgPSBEYXRlLm5vdygpO1xuXG5jb25zdCBnZXRQbGFjZWhvbGRlciA9IChpZCA9IDApID0+IGB7e2gtJHtUSU1FU1RBTVB9LSR7aWR9fX1gO1xuXG5jb25zdCBQTEFDRUhPTERFUl9SRUdFWFBfVEVYVCA9IGdldFBsYWNlaG9sZGVyKCcoXFxcXGQrKScpO1xuY29uc3QgUExBQ0VIT0xERVJfUkVHRVhQX0VRVUFMID0gbmV3IFJlZ0V4cChgXiR7UExBQ0VIT0xERVJfUkVHRVhQX1RFWFR9JGApO1xuY29uc3QgUExBQ0VIT0xERVJfUkVHRVhQX0FMTCA9IG5ldyBSZWdFeHAoUExBQ0VIT0xERVJfUkVHRVhQX1RFWFQsICdnJyk7XG5cbmNvbnN0IEFUVFJfUFJFRklYID0gYC0tJHtUSU1FU1RBTVB9LS1gO1xuY29uc3QgQVRUUl9SRUdFWFAgPSBuZXcgUmVnRXhwKEFUVFJfUFJFRklYLCAnZycpO1xuXG5jb25zdCBwcmVwYXJlZFRlbXBsYXRlcyA9IG5ldyBXZWFrTWFwKCk7XG5cbi8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovXG5mdW5jdGlvbiBhcHBseVNoYWR5Q1NTKHRlbXBsYXRlLCB0YWdOYW1lKSB7XG4gIGlmICghdGFnTmFtZSkgcmV0dXJuIHRlbXBsYXRlO1xuXG4gIHJldHVybiBzaGFkeUNTUygoc2hhZHkpID0+IHtcbiAgICBsZXQgbWFwID0gcHJlcGFyZWRUZW1wbGF0ZXMuZ2V0KHRlbXBsYXRlKTtcbiAgICBpZiAoIW1hcCkge1xuICAgICAgbWFwID0gbmV3IE1hcCgpO1xuICAgICAgcHJlcGFyZWRUZW1wbGF0ZXMuc2V0KHRlbXBsYXRlLCBtYXApO1xuICAgIH1cblxuICAgIGxldCBjbG9uZSA9IG1hcC5nZXQodGFnTmFtZSk7XG5cbiAgICBpZiAoIWNsb25lKSB7XG4gICAgICBjbG9uZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RlbXBsYXRlJyk7XG4gICAgICBjbG9uZS5jb250ZW50LmFwcGVuZENoaWxkKHRlbXBsYXRlLmNvbnRlbnQuY2xvbmVOb2RlKHRydWUpKTtcblxuICAgICAgbWFwLnNldCh0YWdOYW1lLCBjbG9uZSk7XG5cbiAgICAgIGNvbnN0IHN0eWxlcyA9IGNsb25lLmNvbnRlbnQucXVlcnlTZWxlY3RvckFsbCgnc3R5bGUnKTtcblxuICAgICAgQXJyYXkuZnJvbShzdHlsZXMpLmZvckVhY2goKHN0eWxlKSA9PiB7XG4gICAgICAgIGNvbnN0IGNvdW50ID0gc3R5bGUuY2hpbGROb2Rlcy5sZW5ndGggKyAxO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpICs9IDEpIHtcbiAgICAgICAgICBzdHlsZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShnZXRQbGFjZWhvbGRlcigpKSwgc3R5bGUpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgc2hhZHkucHJlcGFyZVRlbXBsYXRlKGNsb25lLCB0YWdOYW1lLnRvTG93ZXJDYXNlKCkpO1xuICAgIH1cbiAgICByZXR1cm4gY2xvbmU7XG4gIH0sIHRlbXBsYXRlKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUlkKHBhcnRzLCBpc1NWRykge1xuICByZXR1cm4gYCR7aXNTVkcgPyAnc3ZnOicgOiAnJ30ke3BhcnRzLmpvaW4oZ2V0UGxhY2Vob2xkZXIoKSl9YDtcbn1cblxuZnVuY3Rpb24gY3JlYXRlU2lnbmF0dXJlKHBhcnRzKSB7XG4gIGNvbnN0IHNpZ25hdHVyZSA9IHBhcnRzLnJlZHVjZSgoYWNjLCBwYXJ0LCBpbmRleCkgPT4ge1xuICAgIGlmIChpbmRleCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHBhcnQ7XG4gICAgfVxuICAgIGlmIChwYXJ0cy5zbGljZShpbmRleCkuam9pbignJykubWF0Y2goL1xccyo8XFwvXFxzKih0YWJsZXx0cnx0aGVhZHx0Ym9keXx0Zm9vdHxjb2xncm91cCk+LykpIHtcbiAgICAgIHJldHVybiBgJHthY2N9PCEtLSR7Z2V0UGxhY2Vob2xkZXIoaW5kZXggLSAxKX0tLT4ke3BhcnR9YDtcbiAgICB9XG4gICAgcmV0dXJuIGFjYyArIGdldFBsYWNlaG9sZGVyKGluZGV4IC0gMSkgKyBwYXJ0O1xuICB9LCAnJyk7XG5cbiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovXG4gIGlmIChJU19JRSkge1xuICAgIHJldHVybiBzaWduYXR1cmUucmVwbGFjZShcbiAgICAgIC9zdHlsZVxccyo9XFxzKihbXCJdW15cIl0rW1wiXXxbJ11bXiddK1snXXxbXlxcc1wiJzw+L10rKS9nLFxuICAgICAgbWF0Y2ggPT4gYCR7QVRUUl9QUkVGSVh9JHttYXRjaH1gLFxuICAgICk7XG4gIH1cblxuICByZXR1cm4gc2lnbmF0dXJlO1xufVxuXG5mdW5jdGlvbiBnZXRQcm9wZXJ0eU5hbWUoc3RyaW5nKSB7XG4gIHJldHVybiBzdHJpbmcucmVwbGFjZSgvXFxzKj1cXHMqWydcIl0qJC9nLCAnJykuc3BsaXQoJyAnKS5wb3AoKTtcbn1cblxuZnVuY3Rpb24gcmVwbGFjZUNvbW1lbnRzKGZyYWdtZW50KSB7XG4gIGNvbnN0IGl0ZXJhdG9yID0gZG9jdW1lbnQuY3JlYXRlTm9kZUl0ZXJhdG9yKGZyYWdtZW50LCBOb2RlRmlsdGVyLlNIT1dfQ09NTUVOVCwgbnVsbCwgZmFsc2UpO1xuICBsZXQgbm9kZTtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbmQtYXNzaWduXG4gIHdoaWxlIChub2RlID0gaXRlcmF0b3IubmV4dE5vZGUoKSkge1xuICAgIGlmIChQTEFDRUhPTERFUl9SRUdFWFBfRVFVQUwudGVzdChub2RlLnRleHRDb250ZW50KSkge1xuICAgICAgbm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShub2RlLnRleHRDb250ZW50KSwgbm9kZSk7XG4gICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVJbnRlcm5hbFdhbGtlcihjb250ZXh0KSB7XG4gIGxldCBub2RlO1xuXG4gIHJldHVybiB7XG4gICAgZ2V0IGN1cnJlbnROb2RlKCkgeyByZXR1cm4gbm9kZTsgfSxcbiAgICBuZXh0Tm9kZSgpIHtcbiAgICAgIGlmIChub2RlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgbm9kZSA9IGNvbnRleHQuY2hpbGROb2Rlc1swXTtcbiAgICAgIH0gZWxzZSBpZiAobm9kZS5jaGlsZE5vZGVzLmxlbmd0aCkge1xuICAgICAgICBub2RlID0gbm9kZS5jaGlsZE5vZGVzWzBdO1xuICAgICAgfSBlbHNlIGlmIChub2RlLm5leHRTaWJsaW5nKSB7XG4gICAgICAgIG5vZGUgPSBub2RlLm5leHRTaWJsaW5nO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50Tm9kZS5uZXh0U2libGluZztcbiAgICAgIH1cblxuICAgICAgcmV0dXJuICEhbm9kZTtcbiAgICB9LFxuICB9O1xufVxuXG5mdW5jdGlvbiBjcmVhdGVFeHRlcm5hbFdhbGtlcihjb250ZXh0KSB7XG4gIHJldHVybiBkb2N1bWVudC5jcmVhdGVUcmVlV2Fsa2VyKFxuICAgIGNvbnRleHQsXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWJpdHdpc2VcbiAgICBOb2RlRmlsdGVyLlNIT1dfRUxFTUVOVCB8IE5vZGVGaWx0ZXIuU0hPV19URVhULFxuICAgIG51bGwsXG4gICAgZmFsc2UsXG4gICk7XG59XG5cbi8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovXG5jb25zdCBjcmVhdGVXYWxrZXIgPSB0eXBlb2Ygd2luZG93LlNoYWR5RE9NID09PSAnb2JqZWN0JyAmJiB3aW5kb3cuU2hhZHlET00uaW5Vc2UgPyBjcmVhdGVJbnRlcm5hbFdhbGtlciA6IGNyZWF0ZUV4dGVybmFsV2Fsa2VyO1xuXG5jb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbmV4cG9ydCBmdW5jdGlvbiBjb21waWxlKHJhd1BhcnRzLCBpc1NWRykge1xuICBjb25zdCB0ZW1wbGF0ZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RlbXBsYXRlJyk7XG4gIGNvbnN0IHBhcnRzID0gW107XG5cbiAgbGV0IHNpZ25hdHVyZSA9IGNyZWF0ZVNpZ25hdHVyZShyYXdQYXJ0cyk7XG4gIGlmIChpc1NWRykgc2lnbmF0dXJlID0gYDxzdmc+JHtzaWduYXR1cmV9PC9zdmc+YDtcblxuICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi9cbiAgaWYgKElTX0lFKSB7XG4gICAgdGVtcGxhdGUuaW5uZXJIVE1MID0gc2lnbmF0dXJlO1xuICB9IGVsc2Uge1xuICAgIGNvbnRhaW5lci5pbm5lckhUTUwgPSBgPHRlbXBsYXRlPiR7c2lnbmF0dXJlfTwvdGVtcGxhdGU+YDtcbiAgICB0ZW1wbGF0ZS5jb250ZW50LmFwcGVuZENoaWxkKGNvbnRhaW5lci5jaGlsZHJlblswXS5jb250ZW50KTtcbiAgfVxuXG4gIGlmIChpc1NWRykge1xuICAgIGNvbnN0IHN2Z1Jvb3QgPSB0ZW1wbGF0ZS5jb250ZW50LmZpcnN0Q2hpbGQ7XG4gICAgdGVtcGxhdGUuY29udGVudC5yZW1vdmVDaGlsZChzdmdSb290KTtcbiAgICBBcnJheS5mcm9tKHN2Z1Jvb3QuY2hpbGROb2RlcykuZm9yRWFjaChub2RlID0+IHRlbXBsYXRlLmNvbnRlbnQuYXBwZW5kQ2hpbGQobm9kZSkpO1xuICB9XG5cbiAgcmVwbGFjZUNvbW1lbnRzKHRlbXBsYXRlLmNvbnRlbnQpO1xuXG4gIGNvbnN0IGNvbXBpbGVXYWxrZXIgPSBjcmVhdGVXYWxrZXIodGVtcGxhdGUuY29udGVudCk7XG4gIGxldCBjb21waWxlSW5kZXggPSAwO1xuXG4gIHdoaWxlIChjb21waWxlV2Fsa2VyLm5leHROb2RlKCkpIHtcbiAgICBjb25zdCBub2RlID0gY29tcGlsZVdhbGtlci5jdXJyZW50Tm9kZTtcblxuICAgIGlmIChub2RlLm5vZGVUeXBlID09PSBOb2RlLlRFWFRfTk9ERSkge1xuICAgICAgY29uc3QgdGV4dCA9IG5vZGUudGV4dENvbnRlbnQ7XG5cbiAgICAgIGlmICghdGV4dC5tYXRjaChQTEFDRUhPTERFUl9SRUdFWFBfRVFVQUwpKSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdHMgPSB0ZXh0Lm1hdGNoKFBMQUNFSE9MREVSX1JFR0VYUF9BTEwpO1xuICAgICAgICBpZiAocmVzdWx0cykge1xuICAgICAgICAgIGxldCBjdXJyZW50Tm9kZSA9IG5vZGU7XG4gICAgICAgICAgcmVzdWx0c1xuICAgICAgICAgICAgLnJlZHVjZSgoYWNjLCBwbGFjZWhvbGRlcikgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBbYmVmb3JlLCBuZXh0XSA9IGFjYy5wb3AoKS5zcGxpdChwbGFjZWhvbGRlcik7XG4gICAgICAgICAgICAgIGlmIChiZWZvcmUpIGFjYy5wdXNoKGJlZm9yZSk7XG4gICAgICAgICAgICAgIGFjYy5wdXNoKHBsYWNlaG9sZGVyKTtcbiAgICAgICAgICAgICAgaWYgKG5leHQpIGFjYy5wdXNoKG5leHQpO1xuICAgICAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICAgICAgfSwgW3RleHRdKVxuICAgICAgICAgICAgLmZvckVhY2goKHBhcnQsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAgIGlmIChpbmRleCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLnRleHRDb250ZW50ID0gcGFydDtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLnBhcmVudE5vZGVcbiAgICAgICAgICAgICAgICAgIC5pbnNlcnRCZWZvcmUoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUocGFydCksIGN1cnJlbnROb2RlLm5leHRTaWJsaW5nKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY29uc3QgZXF1YWwgPSBub2RlLnRleHRDb250ZW50Lm1hdGNoKFBMQUNFSE9MREVSX1JFR0VYUF9FUVVBTCk7XG4gICAgICBpZiAoZXF1YWwpIHtcbiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi9cbiAgICAgICAgaWYgKCFJU19JRSkgbm9kZS50ZXh0Q29udGVudCA9ICcnO1xuICAgICAgICBwYXJ0c1tlcXVhbFsxXV0gPSBbY29tcGlsZUluZGV4LCByZXNvbHZlVmFsdWVdO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLyAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tbG9uZWx5LWlmXG4gICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpIHtcbiAgICAgICAgQXJyYXkuZnJvbShub2RlLmF0dHJpYnV0ZXMpLmZvckVhY2goKGF0dHIpID0+IHtcbiAgICAgICAgICBjb25zdCB2YWx1ZSA9IGF0dHIudmFsdWUudHJpbSgpO1xuICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovXG4gICAgICAgICAgY29uc3QgbmFtZSA9IElTX0lFID8gYXR0ci5uYW1lLnJlcGxhY2UoQVRUUl9QUkVGSVgsICcnKSA6IGF0dHIubmFtZTtcbiAgICAgICAgICBjb25zdCBlcXVhbCA9IHZhbHVlLm1hdGNoKFBMQUNFSE9MREVSX1JFR0VYUF9FUVVBTCk7XG4gICAgICAgICAgaWYgKGVxdWFsKSB7XG4gICAgICAgICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBnZXRQcm9wZXJ0eU5hbWUocmF3UGFydHNbZXF1YWxbMV1dKTtcbiAgICAgICAgICAgIHBhcnRzW2VxdWFsWzFdXSA9IFtjb21waWxlSW5kZXgsIHJlc29sdmVQcm9wZXJ0eShuYW1lLCBwcm9wZXJ0eU5hbWUsIGlzU1ZHKV07XG4gICAgICAgICAgICBub2RlLnJlbW92ZUF0dHJpYnV0ZShhdHRyLm5hbWUpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHRzID0gdmFsdWUubWF0Y2goUExBQ0VIT0xERVJfUkVHRVhQX0FMTCk7XG4gICAgICAgICAgICBpZiAocmVzdWx0cykge1xuICAgICAgICAgICAgICBjb25zdCBwYXJ0aWFsTmFtZSA9IGBhdHRyX18ke25hbWV9YDtcblxuICAgICAgICAgICAgICByZXN1bHRzLmZvckVhY2goKHBsYWNlaG9sZGVyLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IFssIGlkXSA9IHBsYWNlaG9sZGVyLm1hdGNoKFBMQUNFSE9MREVSX1JFR0VYUF9FUVVBTCk7XG4gICAgICAgICAgICAgICAgcGFydHNbaWRdID0gW2NvbXBpbGVJbmRleCwgKGhvc3QsIHRhcmdldCwgYXR0clZhbHVlKSA9PiB7XG4gICAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gZGF0YU1hcC5nZXQodGFyZ2V0LCB7fSk7XG4gICAgICAgICAgICAgICAgICBkYXRhW3BhcnRpYWxOYW1lXSA9IChkYXRhW3BhcnRpYWxOYW1lXSB8fCB2YWx1ZSkucmVwbGFjZShwbGFjZWhvbGRlciwgYXR0clZhbHVlID09IG51bGwgPyAnJyA6IGF0dHJWYWx1ZSk7XG5cbiAgICAgICAgICAgICAgICAgIGlmICgocmVzdWx0cy5sZW5ndGggPT09IDEpIHx8IChpbmRleCArIDEgPT09IHJlc3VsdHMubGVuZ3RoKSkge1xuICAgICAgICAgICAgICAgICAgICB0YXJnZXQuc2V0QXR0cmlidXRlKG5hbWUsIGRhdGFbcGFydGlhbE5hbWVdKTtcbiAgICAgICAgICAgICAgICAgICAgZGF0YVtwYXJ0aWFsTmFtZV0gPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfV07XG4gICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgIGF0dHIudmFsdWUgPSAnJztcblxuICAgICAgICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICAgICAgICAgICAgICBpZiAoSVNfSUUgJiYgbmFtZSAhPT0gYXR0ci5uYW1lKSB7XG4gICAgICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoYXR0ci5uYW1lKTtcbiAgICAgICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZShuYW1lLCAnJyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbXBpbGVJbmRleCArPSAxO1xuICB9XG5cbiAgcmV0dXJuIChob3N0LCB0YXJnZXQsIGFyZ3MpID0+IHtcbiAgICBjb25zdCBkYXRhID0gZGF0YU1hcC5nZXQodGFyZ2V0LCB7IHR5cGU6ICdmdW5jdGlvbicgfSk7XG5cbiAgICBpZiAodGVtcGxhdGUgIT09IGRhdGEudGVtcGxhdGUpIHtcbiAgICAgIGlmIChkYXRhLnRlbXBsYXRlKSByZW1vdmVUZW1wbGF0ZSh0YXJnZXQpO1xuXG4gICAgICBjb25zdCBmcmFnbWVudCA9IGRvY3VtZW50LmltcG9ydE5vZGUoYXBwbHlTaGFkeUNTUyh0ZW1wbGF0ZSwgaG9zdC50YWdOYW1lKS5jb250ZW50LCB0cnVlKTtcblxuICAgICAgY29uc3QgcmVuZGVyV2Fsa2VyID0gY3JlYXRlV2Fsa2VyKGZyYWdtZW50KTtcbiAgICAgIGNvbnN0IGNsb25lZFBhcnRzID0gcGFydHMuc2xpY2UoMCk7XG5cbiAgICAgIGxldCByZW5kZXJJbmRleCA9IDA7XG4gICAgICBsZXQgY3VycmVudFBhcnQgPSBjbG9uZWRQYXJ0cy5zaGlmdCgpO1xuXG4gICAgICBjb25zdCBtYXJrZXJzID0gW107XG5cbiAgICAgIE9iamVjdC5hc3NpZ24oZGF0YSwgeyB0ZW1wbGF0ZSwgbWFya2VycyB9KTtcblxuICAgICAgd2hpbGUgKHJlbmRlcldhbGtlci5uZXh0Tm9kZSgpKSB7XG4gICAgICAgIGNvbnN0IG5vZGUgPSByZW5kZXJXYWxrZXIuY3VycmVudE5vZGU7XG5cbiAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IE5vZGUuVEVYVF9OT0RFKSB7XG4gICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9cbiAgICAgICAgICBpZiAoUExBQ0VIT0xERVJfUkVHRVhQX0VRVUFMLnRlc3Qobm9kZS50ZXh0Q29udGVudCkpIHtcbiAgICAgICAgICAgIG5vZGUudGV4dENvbnRlbnQgPSAnJztcbiAgICAgICAgICB9IGVsc2UgaWYgKElTX0lFKSB7XG4gICAgICAgICAgICBub2RlLnRleHRDb250ZW50ID0gbm9kZS50ZXh0Q29udGVudC5yZXBsYWNlKEFUVFJfUkVHRVhQLCAnJyk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgbm9kZS5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpIHtcbiAgICAgICAgICBpZiAobm9kZS50YWdOYW1lLmluZGV4T2YoJy0nKSA+IC0xICYmICFjdXN0b21FbGVtZW50cy5nZXQobm9kZS50YWdOYW1lLnRvTG93ZXJDYXNlKCkpKSB7XG4gICAgICAgICAgICB0aHJvdyBFcnJvcihgTWlzc2luZyAnJHtzdHJpbmdpZnlFbGVtZW50KG5vZGUpfScgZWxlbWVudCBkZWZpbml0aW9uIGluICcke3N0cmluZ2lmeUVsZW1lbnQoaG9zdCl9J2ApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHdoaWxlIChjdXJyZW50UGFydCAmJiBjdXJyZW50UGFydFswXSA9PT0gcmVuZGVySW5kZXgpIHtcbiAgICAgICAgICBtYXJrZXJzLnB1c2goW25vZGUsIGN1cnJlbnRQYXJ0WzFdXSk7XG4gICAgICAgICAgY3VycmVudFBhcnQgPSBjbG9uZWRQYXJ0cy5zaGlmdCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmVuZGVySW5kZXggKz0gMTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgY2hpbGRMaXN0ID0gQXJyYXkuZnJvbShmcmFnbWVudC5jaGlsZE5vZGVzKTtcblxuICAgICAgZGF0YS5zdGFydE5vZGUgPSBjaGlsZExpc3RbMF07XG4gICAgICBkYXRhLmVuZE5vZGUgPSBjaGlsZExpc3RbY2hpbGRMaXN0Lmxlbmd0aCAtIDFdO1xuXG4gICAgICBpZiAodGFyZ2V0Lm5vZGVUeXBlID09PSBOb2RlLlRFWFRfTk9ERSkge1xuICAgICAgICBsZXQgcHJldmlvdXNDaGlsZCA9IHRhcmdldDtcbiAgICAgICAgY2hpbGRMaXN0LmZvckVhY2goKGNoaWxkKSA9PiB7XG4gICAgICAgICAgdGFyZ2V0LnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGNoaWxkLCBwcmV2aW91c0NoaWxkLm5leHRTaWJsaW5nKTtcbiAgICAgICAgICBwcmV2aW91c0NoaWxkID0gY2hpbGQ7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGFyZ2V0LmFwcGVuZENoaWxkKGZyYWdtZW50KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBkYXRhLm1hcmtlcnMuZm9yRWFjaCgoW25vZGUsIGZuXSwgaW5kZXgpID0+IHtcbiAgICAgIGlmIChkYXRhLmxhc3RBcmdzICYmIGRhdGEubGFzdEFyZ3NbaW5kZXhdID09PSBhcmdzW2luZGV4XSkgcmV0dXJuO1xuICAgICAgZm4oaG9zdCwgbm9kZSwgYXJnc1tpbmRleF0sIGRhdGEubGFzdEFyZ3MgPyBkYXRhLmxhc3RBcmdzW2luZGV4XSA6IHVuZGVmaW5lZCk7XG4gICAgfSk7XG5cbiAgICBkYXRhLmxhc3RBcmdzID0gYXJncztcbiAgfTtcbn1cbiJdfQ==